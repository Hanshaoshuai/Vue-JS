<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="favicon.ico">
    <title>hello-world</title>
  <link href="js/app.js" rel="preload" as="script">
  <style type="text/css">
		  #total{
			-webkit-user-select:text;
			text-align:right;
			padding:0 1em;
			border: 0px;
			border-bottom:1px solid #ECB100;
			border-radius: 0;
			font-size:16px;
			width:30%;
			outline:none;
		  }
		  #dcontent{
			  position: absolute;
			  top:0;
			  left:0;
			  width:100%;
			  height:100%;
			  background-color: #EAEAEA;
			  z-index: 10000;
		  }
		  .button{
			width: 50%;
			height: 50px;
			font-size:18px;
			text-align:center;
			line-height: 50px;
			border-radius: 12px;
			margin: 0 auto;
			margin-bottom: 10px;
			background: #2aae67;
			color: #94d7b3;
		  }
  </style>
  </head>
  <script src="index.js"></script>
  <script src="common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js"></script>
  <script type="text/javascript">
    //取消浏览器的所有事件，使得active的样式在手机上正常生效
        document.addEventListener('touchstart',function(){
            return false;
        },true);
        // 禁止选择
        document.oncontextmenu=function(){
          return false;
        };
    	  function plusReady(){
    		  // plus.navigator.setFullscreen(false);
    		  // plus.navigator.setStatusBarBackground('#D74B28');
    		  // console.log(plus.navigator.getStatusbarHeight())
					plus.navigator.setStatusBarStyle('dark'); //light（白色）、dark（黑色）
          localStorage.setItem("statusbarHeight",plus.navigator.getStatusbarHeight())
    	  	// 隐藏滚动条
    	  	plus.webview.currentWebview().setStyle({scrollIndicator:'none'});
    	  	// Android处理返回键
    	  	plus.key.addEventListener('backbutton',function(){
            var hash = localStorage.getItem("hash")
            if(hash =='Wx' || hash == 'Tx' || hash == 'Fx' || hash == 'Wd'){
              plus.runtime.quit();//那么就退出app
            }else{
              history.go(-1)
            }
    	  		// ('iOS'==plus.os.name)?plus.nativeUI.confirm('确认退出？', function(e){
    	  		// 	if(e.index>0){
    	  		// 		plus.runtime.quit();
    	  		// 	}
    	  		// }, 'HelloH5', ['取消','确定']):(confirm('确认退出？')&&plus.runtime.quit());
    	  	},false);
    	  }
    	  if(window.plus){
    	  	plusReady();
    	  }else{
    	  	document.addEventListener('plusready',plusReady,false);
    	  }
	</script>
  <body>
    <noscript>
      <strong>We're sorry but hello-world doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
	<div id="dcontent" class="dcontent">
		<br/>
		<p id="info" style="padding: 0 1em;text-align:left;display: none;">登录认证通道信息：</p>
		<div style="padding: 0.5em 1em;"><hr color="#EEE"/></div>
		<br/>
		<div id="oauth"></div>
		<br/>
		<div class="button button-waring" onclick="logoutAll()" style="display: none;">注销登录</div>
		<div id="output" style="display: none;">
		OAuth模块管理客户端的用户授权登录验证功能，允许应用访问第三方平台的资源。
		</div>
	</div>
	<script type="text/javascript">
// 		if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) {
//     		alert(navigator.userAgent); 
// 		} else if (/(Android)/i.test(navigator.userAgent)) {
// 		    alert(navigator.userAgent);
// 		} else {
			 	document.getElementById('dcontent').style.display='none';
		// };
		var SignInName= 'HSS1314199'
		var SignIn = localStorage.getItem("SignIns")
		if(SignIn &&  SignIn == SignInName){
			document.getElementById('dcontent').style.display='none';
		}else{
		var auths={};
		function plusReady(){
			// 获取登录认证通道
			plus.oauth.getServices(function(services){
				var content=document.getElementById('dcontent');
				var info=document.getElementById("info");
				var txt="登录认证通道信息：";
				for(var i in services){
					var service=services[i];
					// console.log(JSON.stringify(service),service.id+": "+service.authResult+", "+service.userInfo, service.description);
					auths[service.id]=service;
					txt += "id:"+service.id+", ";
					txt += "description:"+service.description+", ";
					var de=document.createElement('div');
					de.setAttribute('class','button');
					de.setAttribute('onclick','login(this.id)');
					de.id=service.id;
					de.innerText=service.description+"登录";
					oauth.appendChild(de);
				}
				info.innerText=txt;
			},function(e){
				outLine("获取登录认证失败："+e.message);
			});
		}
		document.addEventListener('plusready',plusReady,false);
		// 登录认证
		function login(id){
			outSet("----- 登录认证 -----");
			var auth=auths[id];
			// console.log(JSON.stringify(auth))
			if(auth){
				var w=null;
				if(plus.os.name=="Android"){
					w=plus.nativeUI.showWaiting();
				}
				document.addEventListener("pause",function(){
					setTimeout(function(){
						w&&w.close();w=null;
					},2000);
				}, false );
				// console.log(JSON.stringify(auth))
				auth.login(function(){
					w&&w.close();w=null;
					outLine("登录认证成功：");
					outLine(JSON.stringify(auth.authResult));
					// console.log(JSON.stringify(auth))
					userinfo(auth);
				},function(e){
					w&&w.close();w=null;
					outLine("登录认证失败：");
					outLine("["+e.code+"]："+e.message);
					plus.nativeUI.alert("详情错误信息请参考授权登录(OAuth)规范文档：http://www.html5plus.org/#specification#/specification/OAuth.html",null,"登录失败["+e.code+"]："+e.message);
				});
			}else{
				outLine("无效的登录认证通道！");
				plus.nativeUI.alert("无效的登录认证通道！",null,"登录");
			}
		}
		// 获取用户信息
		function userinfo(a){
			outLine("----- 获取用户信息 -----");
			a.getUserInfo(function(){
				outLine("获取用户信息成功：");
				outLine(JSON.stringify(a.userInfo));
				// console.log(JSON.stringify(a.userInfo))
				var nickname=a.userInfo.nickname||a.userInfo.name||a.userInfo.miliaoNick;
				// plus.nativeUI.alert("欢迎“"+nickname+"”登录成功！");
				plus.nativeUI.confirm(nickname+"登录", function(e){
					if(e.index>0){
						if(nickname.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g,'') == SignInName){
							confirm('登录成功！')
							localStorage.setItem("SignIns",nickname.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g,''));
							document.getElementById('dcontent').style.display='none';
						}else{
							confirm('不存在该用户，登录失败！')&&plus.runtime.quit()
						}
					}else{
						confirm('确认退出？')&&plus.runtime.quit()
						// plus.runtime.quit();
					}
				}, '欢迎', ['取消','确定'])
			},function(e){
				outLine("获取用户信息失败：");
				outLine("["+e.code+"]："+e.message);
				plus.nativeUI.alert("获取用户信息失败！",null,"登录");
			});
		}
		// 注销登录
		function logoutAll(){
			outSet("----- 注销登录认证 -----");
			for(var i in auths){
				logout(auths[i]);
			}
		}
		function logout(auth){
			auth.logout(function(){
				outLine("注销\""+auth.description+"\"成功");
			},function(e){
				outLine("注销\""+auth.description+"\"失败："+e.message);
			});
		}
	}
	</script>
    <div id="app"></div>
    <!-- built files will be auto injected -->
  <script type="text/javascript" src="js/app.js"></script></body>
</html>
